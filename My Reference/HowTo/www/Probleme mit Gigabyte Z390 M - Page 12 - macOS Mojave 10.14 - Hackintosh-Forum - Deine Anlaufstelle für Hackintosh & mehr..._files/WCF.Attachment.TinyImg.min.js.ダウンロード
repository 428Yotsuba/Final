WCF.Attachment.TinyImg={_maxWidth:200,_maxHeight:200,_quality:.85,init:function(a,b,c){this._maxWidth=a;this._maxHeight=b;this._quality=1<c?c/100:c},handleFile:function(a,b){if(!b.file)return!1;var c=document.createElement("img"),f=new FileReader,d=this;f.onload=function(e){c.src=e.target.result;c.onload=function(){d._getOrientation(b.file,function(e){d._scaleImage(c,a,e,b)})}};f.readAsDataURL(b.file)},_getOrientation:function(a,b){var c=new FileReader;c.onload=function(a){a=new DataView(a.target.result);if(65496!=a.getUint16(0,!1))return b(-2);for(var d=a.byteLength,e=2;e<d&&!(8>=a.getUint16(e+2,!1));){var c=a.getUint16(e,!1);e+=2;if(65505==c){if(1165519206!=a.getUint32(e+=2,!1))break;c=18761==a.getUint16(e+=6,!1);e+=a.getUint32(e+4,c);var f=a.getUint16(e,c);e+=2;for(var h=0;h<f;h++)if(274==a.getUint16(e+12*h,c))return b(a.getUint16(e+12*h+8,c))}else if(65280!=(c&65280))break;else e+=a.getUint16(e,!1)}return b(-1)};c.readAsArrayBuffer(a)},_scaleImage:function(a,b,c,f){var d=document.createElement("canvas");d.width=a.width;d.height=a.height;var e=d.getContext("2d");e.save();var g=d.width,m=d.style.width,h=d.height,k=d.style.height;if(1<c)switch(4<c&&(d.width=h,d.style.width=k,d.height=g,d.style.height=m),c){case 2:e.translate(g,0);e.scale(-1,1);break;case 3:e.translate(g,h);e.rotate(Math.PI);break;case 4:e.translate(0,h);e.scale(1,-1);break;case 5:e.rotate(.5*Math.PI);e.scale(1,-1);break;case 6:e.rotate(.5*Math.PI);e.translate(0,-h);break;case 7:e.rotate(.5*Math.PI);e.translate(g,-h);e.scale(-1,1);break;case 8:e.rotate(-.5*Math.PI),e.translate(-g,0)}e.drawImage(a,0,0);e.restore();a=Math.min(this._maxWidth,d.width/d.height*this._maxHeight);0>=a&&(a=1,console.warning("TinyImg: image size is too small"));for(;d.width>=2*a;)d=this._getHalfScaleCanvas(d);d.width>a&&(d=this._scaleCanvasWithAlgorithm(d,a));d="image/jpeg"===f.filetype?d.toDataURL(f.filetype,this._quality):d.toDataURL(f.filetype);b.call(f.context,WCF.Attachment.TinyImg.Util.dataURLToBlob(d),f)},_getHalfScaleCanvas:function(a){var b=document.createElement("canvas");b.width=a.width/2;b.height=a.height/2;b.getContext("2d").drawImage(a,0,0,b.width,b.height);return b},_scaleCanvasWithAlgorithm:function(a,b){var c=document.createElement("canvas"),f=b/a.width;c.width=a.width*f;c.height=a.height*f;var d=a.getContext("2d").getImageData(0,0,a.width,a.height),e=c.getContext("2d").createImageData(c.width,c.height);this.applyBilinearInterpolation(d,e,f);c.getContext("2d").putImageData(e,0,0);return c},applyBilinearInterpolation:function(a,b,c){function f(a,b,e,d,c,f){var g=1-c,h=1-f;return a*g*h+b*c*h+e*g*f+d*c*f}var d,e;for(d=0;d<b.height;++d){var g=d/c;var m=Math.floor(g);var h=Math.ceil(g)>a.height-1?a.height-1:Math.ceil(g);for(e=0;e<b.width;++e){var k=e/c;var l=Math.floor(k);var n=Math.ceil(k)>a.width-1?a.width-1:Math.ceil(k);var r=4*(e+b.width*d);var p=4*(l+a.width*m);var t=4*(n+a.width*m);var u=4*(l+a.width*h);n=4*(n+a.width*h);k-=l;l=g-m;var q=f(a.data[p],a.data[t],a.data[u],a.data[n],k,l);b.data[r]=q;q=f(a.data[p+1],a.data[t+1],a.data[u+1],a.data[n+1],k,l);b.data[r+1]=q;q=f(a.data[p+2],a.data[t+2],a.data[u+2],a.data[n+2],k,l);b.data[r+2]=q;p=f(a.data[p+3],a.data[t+3],a.data[u+3],a.data[n+3],k,l);b.data[r+3]=p}}}};WCF.Attachment.TinyImg.Util={dataURLToBlob:function(a){var b=a.match("data:image/([A-Za-z]+);base64,")[1];a=atob(a.split(",")[1]);var c=new Uint8Array(a.length);len=a.length;for(i=i=0;i<len;i+=1)c[i]=a.charCodeAt(i)&255;return new Blob([c.buffer],{type:"image/"+b})}};WCF.Attachment.Upload.prototype.pendingUploads=[];WCF.Attachment.Upload.prototype._upload=function(a,b,c){if(this._validateLimit()){var f=null;a=[];if(b)a.push(b);else if(c){b="";switch(c.type){case "image/png":b=".png";break;case "image/jpeg":b=".jpg";break;case "image/gif":b=".gif"}a.push({name:"pasted-from-clipboard"+b})}else a=this._fileUpload.prop("files");if(a.length){b=new FormData;f=this._createUploadMatrix(a);if(!this._uploadMatrix[f].length)return null;this.pendingUploads[f]={uploadID:f,runningScales:0,pendingImages:[],formData:null};for(var d="",e,g=0,m=a.length;g<m;g++)if(this._uploadMatrix[f][g]){var h=this._uploadMatrix[f][g].data("internalFileID");e=a[g].name;if(c)d=c.type;else if(a[g].type)d=a[g].type;else switch(e.split(".").pop()){case "png":d="image/png";break;case "jpg":case "jpeg":d="image/jpeg";break;case "gif":d="image/gif"}fileData={file:c?c:a[g],filename:e,filetype:d,internalFileID:h,uploadID:f};-1<["image/png","image/jpeg"].indexOf(d)&&window.HTMLCanvasElement&&window.Blob&&window.Uint8Array?this.pendingUploads[f].pendingImages.push(fileData):this._validateUploadMaxSize(fileData)&&b.append("__files["+h+"]",fileData.file,fileData.file.name)}this.pendingUploads[f].formData=b;this._handleUpload()}}this._fileUpload&&(this._removeButton(),this._createButton());return f};WCF.Attachment.Upload.prototype._handleUpload=function(){if(0!==this.pendingUploads.length){var a=this.pendingUploads.length-1;this.pendingUploads[a]&&"undefined"!==typeof a?0===this.pendingUploads[a].pendingImages.length&&0===this.pendingUploads[a].runningScales?(this._scUpload(this.pendingUploads[a].formData,a),delete this.pendingUploads[a]):0<this.pendingUploads[a].pendingImages.length&&this._resize(a):(delete this.pendingUploads[a],this._handleUpload())}};WCF.Attachment.Upload.prototype._resize=function(a){var b=this.pendingUploads[a].pendingImages.pop();b?(this.pendingUploads[a].runningScales++,b.context=this,WCF.Attachment.TinyImg.handleFile(this._resizeCallback,b)):this._handleUpload()};WCF.Attachment.Upload.prototype._resizeCallback=function(a,b){b.file.size>a.size&&(b.file=a);this._validateUploadMaxSize(b)&&this.pendingUploads[b.uploadID].formData.append("__files["+b.internalFileID+"]",b.file,b.filename);this.pendingUploads[b.uploadID].runningScales--;this._handleUpload()};WCF.Attachment.Upload.prototype._scSuccess=function(a,b){var c;for(c in this._uploadMatrix[a])if(this._uploadMatrix[a].hasOwnProperty(c)){var f=this._uploadMatrix[a][c];f.data("filename");var d=f.data("internalFileID");b.returnValues&&b.returnValues.attachments[d]&&(d=b.returnValues.attachments[d],d.filename&&f.data("filename",d.filename))}this._success(a,b)};WCF.Attachment.Upload.prototype._scUpload=function(a,b){a.append("actionName",this._options.action);a.append("className","wcf\\data\\attachment\\TinyImgAttachmentAction");var c=this._getParameters(),f=this,d;for(d in c)a.append("parameters["+d+"]",c[d]);$.ajax({type:"POST",url:this._options.url,enctype:"multipart/form-data",data:a,contentType:!1,processData:!1,success:function(a,c,d){f._scSuccess(b,a)},error:$.proxy(this._error,this),xhr:function(){var a=$.ajaxSettings.xhr();a&&a.upload.addEventListener("progress",function(a){f._progress(b,a)},!1);return a},xhrFields:{withCredentials:!0}})};WCF.Attachment.Upload.prototype._validateUploadMaxSize=function(a){if(!this._uploadMatrix[a.uploadID])return!1;if(this._buttonSelector.data("maxSize")<a.file.size)for(var b=0,c=this._uploadMatrix[a.uploadID].length;b<c;b++)if(this._uploadMatrix[a.uploadID][b]&&this._uploadMatrix[a.uploadID][b].data("internalFileID")===a.internalFileID)return $li=this._uploadMatrix[a.uploadID][b],$li.find("progress").remove(),$li.children(".fa-spinner").removeClass("fa-spinner").addClass("fa-ban"),$li.find("div > div").append($('<small class="innerError">'+WCF.Language.get("wcf.attachment.upload.error.tooLarge")+"</small>")),$li.addClass("uploadFailed"),delete this._uploadMatrix[a.uploadID][b],!1;return!0};WCF.Attachment.Upload.prototype._initFile=function(a){a=$('<li class="box64"><span class="icon icon64 fa-spinner" /><div><div><p>'+a.name+'</p><small><progress max="100"></progress></small></div><ul></ul></div></li>').data("filename",a.name);this._fileListSelector.append(a);this._fileListSelector.show();return a}