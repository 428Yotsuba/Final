var Push={};Push.Handler=Class.extend({_socket:null,_connected:false,init:function(b){this._socket=new WebSocket(b);this._socket.onopen=$.proxy(this._onConnect,this);this._socket.onmessage=$.proxy(this._onMessage,this);this._socket.onerror=$.proxy(this._onError,this);this._socket.onclose=$.proxy(this._onDisconnect,this);var a=this;window.onbeforeunload=function(){a._socket.close()}},_onError:function(a){console.log(a);require(["EventHandler"],(function(b){b.fire("de.wbb-elite.push++","error",a)}).bind(this))},_onConnect:function(){require(["EventHandler"],(function(a){a.fire("de.wbb-elite.push++","connect")}).bind(this));this._connected=true},_onMessage:function(b){var a=JSON.parse(b.data);if(!a.objectID||!a.type){return}require(["EventHandler"],(function(c){c.fire("de.wbb-elite.push++","message_"+a.type+"_"+a.objectID,a)}).bind(this))},_onDisconnect:function(a){require(["EventHandler"],(function(b){b.fire("de.wbb-elite.push++","disconnect",a)}).bind(this));this._connected=false}});Push.Notification=Class.extend({_options:{},_objectID:0,_proxy:null,_defaultMessage:"",_data:null,init:function(a){this._options=$.extend(true,{onConnect:false,onMessage:true,type:false,onDisconnect:false},a||{});if(!this._options.type){return}this._proxy=new WCF.Action.Proxy({showLoadingOverlay:false,success:$.proxy(this._success,this)});require(["EventHandler"],(function(b){if(this._options.onConnect===true){b.add("de.wbb-elite.push++","connect",this._onConnect.bind(this))}if(this._options.onMessage===true){b.add("de.wbb-elite.push++","message_"+this._options.type+"_"+this._objectID,this._onMessage.bind(this))}if(this._options.onDisconnect===true){b.add("de.wbb-elite.push++","disconnect",this._onDisconnect.bind(this))}}).bind(this))},_onConnect:function(){throw Error("Unsupported function")},_onMessage:function(a){this._data=a;setTimeout(this._reload.bind(this),1000)},_showMessage:function(){require(["Ui/Notification","Language"],(function(b,a){b.show(a.get(this._data.message?this._data.message:this._defaultMessage),null,"info")}).bind(this));Push.Notification.Handler.changePushTitle(this._data.message?this._data.message:this._defaultMessage)},_showNotification:function(a){Push.Notification.Handler._showNotification({notification:{title:this._data.message?this._data.message:this._defaultMessage,message:this._data.data&&this._data.data.body?this._data.data.body:"",scroll:a?a:null}})},_onDisconnect:function(){throw Error("Unsupported function")},_success:function(a){throw Error("Unsupported function")},_reload:function(){throw Error("Unsupported function")}});Push.Notification.User=Push.Notification.extend({_defaultMessage:"de.wbb-elite.push++.notification.user",init:function(a){require(["User"],(function(b){this._objectID=b.userId}).bind(this));this._super($.extend(true,{type:"userID"},a||{}))},_success:function(a){if(a.returnValues.totalCount){this._showMessage();this._showNotification();WCF.System.PushNotification.executeCallbacks({returnValues:{userNotificationCount:a.returnValues.totalCount}})}},_reload:function(){this._proxy.setOption("data",{actionName:"getOutstandingNotifications",className:"wcf\\data\\user\\notification\\UserNotificationAction"});this._proxy.sendRequest()}});Push.Notification.Conversation=Push.Notification.extend({lastPostTime:0,pageNo:0,_defaultMessage:"de.wbb-elite.push++.notification.conversation",init:function(d,a,c,b){this._objectID=d;this._lastPostTime=c;this._pageNo=a;this._super($.extend(true,{type:"conversation"},b||{}));new Push.Notification.Conversation.Update(d,a,b)},_success:function(e){if(e.returnValues.template===undefined||e.returnValues.nextPageNotice===undefined||!e.returnValues.lastPostTime||e.returnValues.templatePageLinks===undefined){return}this._lastPostTime=e.returnValues.lastPostTime?e.returnValues.lastPostTime:this._lastPostTime;var d=$("body#tpl_wcf_conversation div.section > .messageList");var b=$(".messageListPagination",d);var a=elById("messageQuickReply");$(".moreConversationNotice").remove();var c=$(e.returnValues.template);c.each(function(g,h){var f=elData(elBySel("article.message",this),"object-id");if(elById("message"+f)){delete c[g]}});if(c.find("li").length>0){this._showMessage();if(a){if(b.length){c.insertBefore(b)}else{c.insertBefore(a)}}else{if(b.length){c.insertBefore(b)}else{d.append(c)}}this._showNotification(elById(elAttr(c[0],"id")))}if(e.returnValues.nextPageNotice){if(a){$('<li class="moreConversationNotice"><p class="info">'+e.returnValues.nextPageNotice+"</p></li>").insertBefore(a)}else{d.append($('<li class="moreConversationNotice"><p class="info">'+e.returnValues.nextPageNotice+"</p></li>"))}}if(a){elData(a,"last-post-time",e.returnValues.lastPostTime)}if(b.length){$(b.find(".pagination")).html($(e.returnValues.templatePageLinks).html());WCF.System.PageNavigation.init(".pagination")}},_reload:function(){var a=elById("messageQuickReply");if(a){this._lastPostTime=this._lastPostTime>parseInt(elData(a,"last-post-time"))?this._lastPostTime:parseInt(elData(a,"last-post-time"))}this._proxy.setOption("data",{actionName:"reloadConversation",className:"wcf\\data\\conversation\\ConversationPushAction",parameters:{lastPostTime:this._lastPostTime,pageNo:this._pageNo},objectIDs:[this._objectID]});this._proxy.sendRequest()}});Push.Notification.Conversation.Update=Push.Notification.extend({pageNo:0,_messageIDs:[],_defaultMessage:"de.wbb-elite.push++.notification.conversation.update",init:function(c,a,b){this._objectID=c;this._pageNo=a;this._super($.extend(true,{type:"conversationUpdate"},b||{}))},_success:function(b){if(b.returnValues.template===undefined){return}var a=this;require(["WoltLabSuite/Core/Dom/Util"],(function(d){var c=d.createFragmentFromHtml(b.returnValues.template);elBySelAll("article.message",c,function(j){var f=elData(j,"object-id");var h=elBySel("#message"+f+" > article.message",elById("tpl_wcf_conversation"));if(h){d.setInnerHtml(elBySel(".messageBody > .messageText",h),elBySel(".messageBody > .messageText",j).innerHTML);var k=elBySelAll("footer.messageFooter > .attachmentThumbnailList, .attachmentFileList",h);var m=elBySel("footer.messageFooter > .attachmentThumbnailList",j);var e=elBySel("footer.messageFooter",h);if(k){for(var g=0,l=k.length;g<l;g++){elRemove(k[g])}}if(m){e.insertBefore(m,e.firstChild)}a._showMessage()}})}).bind(this))},_reload:function(){this._proxy.setOption("data",{actionName:"reloadConversationMessage",className:"wcf\\data\\conversation\\ConversationPushAction",parameters:{pageNo:this._pageNo,index:parseInt(elBySel("ul.messageQuickOptions > li > a",elById("message"+this._data.data.messageID)).innerHTML.replace("#","")),messageID:this._data.data.messageID},objectIDs:[this._objectID]});this._proxy.sendRequest()}});Push.Notification.Handler={_pushCounter:0,_oldPushTitle:document.title,_onPushFocus:true,_pushLastMessage:"",_allowNotification:false,_icon:"",init:function(a){this._icon=a;window.addEventListener("blur",(function(){this._pushCounter=0;this._onPushFocus=false}).bind(this));window.addEventListener("focus",(function(){document.title=this._oldPushTitle;this._pushCounter=0;this._onPushFocus=true;if(this._pushLastMessage.trim()){require(["Ui/Notification","Language"],(function(c,b){c.show(b.get(this._pushLastMessage),null,"info")}).bind(this));this._pushLastMessage=""}}).bind(this));if(("Promise" in window)&&("Notification" in window)){switch(window.Notification.permission){case"granted":this._allowNotification=true;break;default:window.Notification.requestPermission(function(b){if(b==="granted"){self._allowNotification=true}});break}}},_showNotification:function(a){if(!this._allowNotification){return}if(typeof a.notification==="object"&&typeof a.notification.message==="string"){require(["StringUtil","Language"],(function(c,b){var d=new window.Notification(b.get(a.notification.title),{body:c.unescapeHTML(b.get(a.notification.message)),icon:this._icon});d.onclick=function(){window.focus();d.close();if(a.notification.scroll){a.notification.scroll.scrollIntoView({behavior:"smooth"})}}}))}},changePushTitle:function(a){if(this._onPushFocus){return}this._pushCounter++;this._pushLastMessage=a;document.title="("+this._pushCounter+") "+this._oldPushTitle}};